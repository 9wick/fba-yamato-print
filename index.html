<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>PDF Drag & Drop Print (1 page)</title>
        <style>
            :root {
                --paper-w: 210mm; /* A5 横 */
                --paper-h: 148mm; /* A5 横 */
            }
            body {
                margin: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    sans-serif;
            }
            header {
                padding: 12px 16px;
                border-bottom: 1px solid #e5e5e5;
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }
            .hint {
                color: #666;
                font-size: 12px;
            }
            .controls {
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }
            label {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            input[type="range"] {
                width: 220px;
            }
            input[type="number"] {
                width: 90px;
            }

            main {
                padding: 16px;
                display: grid;
                gap: 16px;
            }
            .dropzone {
                border: 2px dashed #bbb;
                border-radius: 12px;
                padding: 18px;
                text-align: center;
                color: #555;
                background: #fafafa;
            }
            .dropzone.dragover {
                border-color: #3b82f6;
                background: #eff6ff;
                color: #1e40af;
            }

            /* 画面プレビュー：紙サイズの枠 */
            .paper {
                width: var(--paper-w);
                height: var(--paper-h);
                border: 1px solid #ddd;
                border-radius: 10px;
                background: white;
                box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
                overflow: hidden;
                position: relative;
            }
            .paperWrap {
                display: grid;
                justify-content: start;
                gap: 10px;
            }
            .paperTitle {
                font-size: 12px;
                color: #666;
            }

            /* 印刷対象（canvas）を包む要素。ここに transform を当てる */
            #printableWrap {
                position: absolute;
                top: 0;
                left: 0;
                transform-origin: top left;
                cursor: grab;
                user-select: none;
                touch-action: none;
            }
            #printableWrap:active {
                cursor: grabbing;
            }

            #pdfCanvas {
                display: block;
            }

            /* 印刷設定 */
            @page {
                size: A5 landscape;
                margin: 0;
            }

            @media print {
                header,
                .dropzone,
                .paperTitle,
                .hint,
                .controls {
                    display: none !important;
                }
                body,
                main {
                    margin: 0;
                    padding: 0;
                }
                main {
                    display: block;
                }
                /* 印刷時は紙枠のボーダー影など不要 */
                .paper {
                    border: 0;
                    border-radius: 0;
                    box-shadow: none;
                }
                /* 重要：印刷時も同じ transform を効かせる（JSでstyleに直接セットするのでOK） */
            }
        </style>
    </head>
    <body>
        <header>
            <div>
                <div><strong>PDF Drag & Drop Print（1ページ）</strong></div>
                <div class="hint">
                    概要: Amazon
                    FBAのPDFをクロネコヤマトA5横に合わせて印刷する簡易ツール。<br />
                    使い方: PDFをドロップして印刷。
                    もし微調整が必要なら下部で調整し、印刷。
                </div>
            </div>

            <button id="printBtn" class="screenOnly" disabled>印刷</button>
            <button id="resetBtn" class="screenOnly" disabled>リセット</button>
            <input
                id="filePick"
                class="screenOnly"
                type="file"
                accept="application/pdf"
            />
        </header>

        <main>
            <div id="dropzone" class="dropzone">
                <div>ここにPDFをドラッグ＆ドロップ</div>
                <div class="hint">または右上のファイル選択から</div>
            </div>

            <div class="paperWrap">
                <div class="paperTitle">
                    プレビュー（A5横 210×148mm / 余白0）
                </div>
                <div class="paper" id="paper">
                    <div id="printableWrap">
                        <canvas id="pdfCanvas"></canvas>
                    </div>
                </div>
                <div class="controls">
                    <label
                        >Scale
                        <input
                            id="scale"
                            type="range"
                            min="0.50"
                            max="2.50"
                            step="0.01"
                            value="1.73"
                        />
                        <input
                            id="scaleNum"
                            type="number"
                            min="0.50"
                            max="2.50"
                            step="0.01"
                            value="1.73"
                        />
                    </label>

                    <label
                        >Offset X (mm)
                        <input
                            id="offX"
                            type="number"
                            step="0.1"
                            value="-10.0"
                        />
                    </label>

                    <label
                        >Offset Y (mm)
                        <input
                            id="offY"
                            type="number"
                            step="0.1"
                            value="-20.0"
                        />
                    </label>

                    <label
                        >描画解像度(目安)
                        <select id="renderQuality">
                            <option value="5.0">そこそこ</option>
                            <option value="10.0">高め</option>
                            <option value="20.0" selected>めちゃ高</option>
                        </select>
                    </label>
                </div>
                <div class="hint">
                    位置調整はキャンバスをドラッグ、またはOffset(mm)を直接入力。Scaleはスライダーで調整。
                </div>
            </div>
        </main>

        <!-- pdf.js CDN -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs"
            type="module"
        ></script>
        <script type="module">
            // pdf.js worker
            const { pdfjsLib } = globalThis;
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.mjs";

            const $ = (id) => document.getElementById(id);

            const dropzone = $("dropzone");
            const filePick = $("filePick");
            const printBtn = $("printBtn");
            const resetBtn = $("resetBtn");

            const scaleRange = $("scale");
            const scaleNum = $("scaleNum");
            const offX = $("offX");
            const offY = $("offY");
            const renderQuality = $("renderQuality");

            const printableWrap = $("printableWrap");
            const canvas = $("pdfCanvas");
            const ctx = canvas.getContext("2d");

            let currentPdf = null;
            let currentPage = null;
            let baseViewport = null; // scale=1 相当の viewport
            let dragging = false;
            let dragStart = { x: 0, y: 0 };
            let startOffsetPx = { x: 0, y: 0 };

            // mm <-> px 変換（CSSピクセル基準 96dpi）
            const mmToPx = (mm) => (mm * 96) / 25.4;
            const pxToMm = (px) => (px * 25.4) / 96;

            function applyTransform() {
                const s = parseFloat(scaleNum.value);
                const xMm = parseFloat(offX.value);
                const yMm = parseFloat(offY.value);
                printableWrap.style.transform = `translate(${xMm}mm, ${yMm}mm) scale(${s})`;
            }

            function setControlsEnabled(enabled) {
                printBtn.disabled = !enabled;
                resetBtn.disabled = !enabled;
            }

            function syncScaleInputs(from) {
                if (from === "range") {
                    scaleNum.value = scaleRange.value;
                } else {
                    scaleRange.value = scaleNum.value;
                }
                applyTransform();
            }

            async function renderFirstPage() {
                if (!currentPage) return;

                // 「描画品質」用のスケール：canvas解像度を上げるための係数
                const q = parseFloat(renderQuality.value);

                // PDFの1ページを適度に描画（baseViewportは scale=1 の基準）
                baseViewport = currentPage.getViewport({ scale: 1 });

                const viewport = currentPage.getViewport({ scale: q });
                canvas.width = Math.floor(viewport.width);
                canvas.height = Math.floor(viewport.height);

                // 画面上の見た目サイズ（CSSサイズ）は「qで描いたものをqで割る」＝実質 scale=1 の大きさ
                canvas.style.width = viewport.width / q + "px";
                canvas.style.height = viewport.height / q + "px";

                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                await currentPage.render({ canvasContext: ctx, viewport })
                    .promise;

                applyTransform();
            }

            async function loadPdfFromFile(file) {
                if (!file || file.type !== "application/pdf") {
                    alert("PDFファイルを指定してください。");
                    return;
                }

                const buf = await file.arrayBuffer();
                currentPdf = await pdfjsLib.getDocument({ data: buf }).promise;
                currentPage = await currentPdf.getPage(1);

                // 初期値
                scaleRange.value = "1.73";
                scaleNum.value = "1.73";
                offX.value = "-10.0";
                offY.value = "-20.0";

                await renderFirstPage();
                setControlsEnabled(true);
            }

            // Drag & Drop
            dropzone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropzone.classList.add("dragover");
            });
            dropzone.addEventListener("dragleave", () =>
                dropzone.classList.remove("dragover"),
            );
            dropzone.addEventListener("drop", async (e) => {
                e.preventDefault();
                dropzone.classList.remove("dragover");
                const file = e.dataTransfer.files?.[0];
                await loadPdfFromFile(file);
            });

            // File picker
            filePick.addEventListener("change", async (e) => {
                const file = e.target.files?.[0];
                await loadPdfFromFile(file);
                // 同じファイルを再選択できるように
                filePick.value = "";
            });

            // Controls
            scaleRange.addEventListener("input", () =>
                syncScaleInputs("range"),
            );
            scaleNum.addEventListener("input", () => syncScaleInputs("num"));
            offX.addEventListener("input", applyTransform);
            offY.addEventListener("input", applyTransform);

            renderQuality.addEventListener("change", async () => {
                if (!currentPage) return;
                await renderFirstPage();
            });

            resetBtn.addEventListener("click", async () => {
                if (!currentPage) return;
                scaleRange.value = "1.73";
                scaleNum.value = "1.73";
                offX.value = "-10.0";
                offY.value = "-20.0";
                await renderFirstPage();
                applyTransform();
            });

            printBtn.addEventListener("click", () => window.print());

            // 位置調整（ドラッグでオフセット更新）
            printableWrap.addEventListener("pointerdown", (e) => {
                if (!currentPage) return;
                dragging = true;
                printableWrap.setPointerCapture(e.pointerId);
                dragStart = { x: e.clientX, y: e.clientY };

                // 現在のオフセット(mm)をpxへ
                startOffsetPx = {
                    x: mmToPx(parseFloat(offX.value || "0")),
                    y: mmToPx(parseFloat(offY.value || "0")),
                };
            });

            printableWrap.addEventListener("pointermove", (e) => {
                if (!dragging) return;
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;

                // mmへ戻す
                const newXmm = pxToMm(startOffsetPx.x + dx);
                const newYmm = pxToMm(startOffsetPx.y + dy);

                offX.value = newXmm.toFixed(1);
                offY.value = newYmm.toFixed(1);
                applyTransform();
            });

            printableWrap.addEventListener("pointerup", () => {
                dragging = false;
            });
            printableWrap.addEventListener("pointercancel", () => {
                dragging = false;
            });

            // 使い方：ファイル選択ボタンもクリックしやすくする
            dropzone.addEventListener("click", () => filePick.click());
        </script>
    </body>
</html>
